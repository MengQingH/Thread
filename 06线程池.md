## 线程池
线程池是一种基于池化思想管理线程的工具，经常出现在多线程服务器中，如MySQL。
线程过多会带来额外的开销，其中包括创建销毁线程的开销、调度线程的开销等等，同时也降低了计算机的整体性能。线程池维护多个线程，等待监督管理者分配可并发执行的任务。使用线程池可以代码一系列好处：
* 降低资源消耗：通过池化技术重复利用已创建的线程，降低线程创建和销毁带来的损耗。
* 提高响应速度：任务到达时，无需等待线程即可立即执行。
* 提高线程的可管理性：线程是稀缺资源，如果无限制创建，不仅会消耗系统资源，还会因为线程的不合理分布导致资源调度失衡，降低系统的稳定性。使用线程池可以进行统一的分配、调优和监控。
* 提供更多更强大的功能：线程池具备可拓展性，允许开发人员向其中增加更多的功能。

## 线程池解决的问题
线程池解决的核心问题就是资源管理问题。在并发环境下，系统不能够确定在任意时刻中，有多少任务需要执行，有多少资源需要投入。这种不确定性将带来一下若干问题：
1. 频繁申请、销毁和调度资源，将带来额外消耗。
2. 对资源无限申请缺少抑制手段，易引发系统资源耗尽的风险。
3. 系统无法合理管理内部的资源分布，会降低系统的稳定性。
为了解决资源分配这个问题，线程池采用池化的思想。池化，顾名思义，是为了最大化收益并最小化风险，而将资源统一在一起管理的一种思想。

## 线程池的核心设计与实现
### 总体设计
Java中的线程池核心实现类是ThreadPoolExecutor，ThreadPoolExecutor的UML类图如图所示：
<br><img src=img/ThreadPoolExecutorUML.png><br>ThreadPoolExecutor UML类图<br>

ThreadPoolExecutor的顶层接口是Executor，源码如下：
```java
public interface Executor {
    void execute(Runnable command);
}
```
顶层接口Executor提供了一种思想：将任务提交和任务执行进行解耦。用户无需关注如何创建线程，如何调度线程来执行任务，用户只需提供Runnable对象，将任务的运行逻辑提交到执行器(Executor)中，由Executor框架完成线程的调配和任务的执行部分。

ExecutorService接口增加了一些功能：扩充任务的能力，补充可以为一个或一批异步任务生成Future的方法；提供了管控线程池的方法，比如停止线程池的运行。

AbstractExecutorService是上层的抽象类，将执行任务的流程串联起来，保证下层的实现只需关注一个执行任务的方法即可。

最下层的实现类ThreadPoolExecutor实现最复杂的运行部分，ThreadPoolExecutor将会一方面维护自身的生命周期，另一方面同时管理线程和任务，使两者良好的结合从而执行并行任务。

ThreadPoolExecutor运行，同时维护线程和执行任务的运行机制如下图所示：
<br><img src=img/ThreadPoolExecutor运行流程.png><br>
线程池在内部实际上构建了一个生产者消费者模型，将线程和任务两者解耦，并不直接关联，从而良好的缓冲任务，复用线程。线程池的运行主要分成两部分：任务管理、线程管理。任务管理部分充当生产者的角色，当任务提交后，线程池会判断该任务后续的流转：
1. 直接申请线程执行该任务
2. 缓冲到队列中等待线程执行
3. 拒绝该任务
线程管理部分是消费者，他们被统一维护在线程池内，根据任务请求进行线程的分配，当线程执行完任务后则会继续获取新的任务去执行，最终当线程获取不到任务的时候，线程就会被回收。